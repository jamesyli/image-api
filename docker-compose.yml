services:
  pubsub:
    image: google/cloud-sdk:slim
    platform: linux/amd64
    command:
      - /bin/sh
      - -c
      - |
        apt-get update
        apt-get install -y openjdk-17-jre-headless google-cloud-cli-pubsub-emulator
        gcloud beta emulators pubsub start --host-port=0.0.0.0:8085
    ports:
      - "8085:8085"

  mysql:
    image: mysql:8.3
    environment:
      MYSQL_ROOT_PASSWORD: pass
      MYSQL_DATABASE: image_api
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-ppass"]
      interval: 5s
      timeout: 3s
      retries: 10

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      JOB_DB_DSN: root:pass@tcp(mysql:3306)/image_api?parseTime=true
      GCP_PROJECT_ID: local-project
      PUBSUB_TOPIC: image-jobs
      PUBSUB_MODE: emulator
      PUBSUB_EMULATOR_HOST: pubsub:8085
    ports:
      - "8000:8080"
    depends_on:
      mysql:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      JOB_DB_DSN: root:pass@tcp(mysql:3306)/image_api?parseTime=true
      UPLOAD_BACKEND: local
      LOCAL_STORAGE_DIR: /tmp/image-api
      LOCAL_STORAGE_BASE_URL: http://localhost:8001/files
      LOCAL_STORAGE_SERVE: "true"
    ports:
      - "8001:8080"
    depends_on:
      mysql:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully

  publisher:
    build:
      context: .
      dockerfile: Dockerfile.publisher
    environment:
      JOB_DB_DSN: root:pass@tcp(mysql:3306)/image_api?parseTime=true
      GCP_PROJECT_ID: local-project
      PUBSUB_TOPIC: image-jobs
      PUBSUB_SUBSCRIPTION: image-jobs-push
      PUBSUB_PUSH_ENDPOINT: http://worker:8080/pubsub/jobs
      PUBSUB_MODE: emulator
      PUBSUB_EMULATOR_HOST: pubsub:8085
      OUTBOX_POLL_INTERVAL: "2"
      OUTBOX_BATCH_SIZE: "10"
    depends_on:
      mysql:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully

  migrate:
    build:
      context: .
      dockerfile: Dockerfile.migrate
    command: ["/app/migrate"]
    environment:
      JOB_DB_DSN: root:pass@tcp(mysql:3306)/image_api?parseTime=true
    depends_on:
      mysql:
        condition: service_healthy
